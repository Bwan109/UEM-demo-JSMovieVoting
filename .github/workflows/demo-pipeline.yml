name: Moving Voting App Pipeline Demo
on: [push]
jobs:
  docker:
    name: Build and push Docker images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push server image
        uses: docker/build-push-action@v3
        with:
          context: ./server
          push: true
          tags: vsgdev/jsmovievoting_api:1.0.0
      - name: Build and push client image
        uses: docker/build-push-action@v3
        with:
          context: ./client
          push: true
          tags: vsgdev/jsmovievoting_client:1.0.0
  kubernetes:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    steps:
    - name: Setup kubectl
      uses: azure/setup-kubectl@v2.0
      with:
        version: latest
      id: install
    - name: Configure GKE gsa-key.json file
      run: |
        echo -n 'ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAiY2lyY3VsYXItZnVzaW9uLTM0ODExMSIsCiAgInByaXZhdGVfa2V5X2lkIjogImMxMzFmNDdkZWU2NzlkZWMyMTk2ZTBmYmMzZmQxMDE0ZWRmYTA3MWYiLAogICJwcml2YXRlX2tleSI6ICItLS0tLUJFR0lOIFBSSVZBVEUgS0VZLS0tLS1cbk1JSUV2Z0lCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktnd2dnU2tBZ0VBQW9JQkFRQzI3b1VnWXlsbFo2aWFcbkdGZStMODQ4TGpIQWNSTXJKSWFEc1Z5dFZlTUVrVndYcTFxM3R3emRNSjB3SEZuUHZHTy90WTNSVjArZWxmaW5cblpvRGI5L3o3Qi9QTkNwVkNOU0lwVVdhN2ZLQW9aTUs1ZVdPbk1adVdSdmk4bEk3WDgxSFN4cTdzWjZ2WVdaNEVcblZsZVpJUFR1eEg2dFJlaFByYndvRk94WHRrRWJmVUYySkRoUFhIckovSUJYbzh2UTh4TFg5VDRGVFhucFFBdUNcbmowbTEwb3Fld3NuT1g4NlhzN3U0a1FubmVva3NwZDZEenRvOWREL2ZyQzlsc09yK0FvMDdxcTJnZmU5OTl4YTdcbnh6VjJzZWpZeE1QMVFUSEhTVnFlMnlIN3ZySXhndi9YWmZMSHprZU8rWWFWMW11enlRSnh6NWJMOWR0MzBweG1cblVnTzBnNWZYQWdNQkFBRUNnZ0VBQTQzLy9VQ2dDYzNwVzFFMHgwZlRpSnpYTDZlaTJUaEUrdU1qNjJSYlhIZmNcbm84TWJLSzNBYkwzb21Bbzgvb25wSUUwTlcrK0g1d3VBQVBTL2RVYk0zaTNwNFdhZXZ1SWNiMVFiSEhLUUJDanRcbkZjQ1RuS2ljbnQ5ekx1cnVHYWtyUWw3RkFHZ0ZVVmR3ZUNJYllxamV5Wkw4NlM0T0ZScEpxVGU2M2Z0M0tXc05cbnhEVC85NWJyOXlJbTZaL2d5VnFRZmpNRncvbUdoUnA3L0hhcXpsUW1tUzVsLzRsck80Zm1JRjFncWhycVJxQVNcbkdleUQ4NzZ6SGtNUklIWnEyUXFzcDkzQWg4bDZuR1RqMkxrUFBWVVVpMk9rZkVGdlRZYW5lb0t1UzZ4TFRNSUFcbjh0R28wWTJ0aVFaSmFGMHJDYmxGTUZJdFNoUjA0V3ArQklrdjZuYlFSUUtCZ1FEZWhuTU0rdVladDM5dVVuT0Rcbi91aDJzaGJHRFhsdUE0WXdWZWQ5NFNWdjdzTGd3MHVQZmZ4d1kvcXlPdS9INEZRYnRNSlRMQmhaM1JJK3pMd2RcbnVldm0rN1g5azZEYmJWZWorZnd4Y29YemFuaUd1YlAwTUZDQlZCdTJ5Vk5tNUcxTUNxallCT1YzcDdUSzJaYkJcbnptN0k3MmJIc3ZjaHI3NkhLOWNqNHV2RERRS0JnUURTYzA2aVVQZUdKa1A0b3RTN3cwdmZQR0ZYR2dzNlRxaHpcbktCb0Z1YitESnMyNE5VOWttZGNmMjE3MGt2OFJ6SUJBY3FnS3lOeEhIR1V4dU9qaEV5S3J4UXpVdW9zdTA0TW9cbkRobHIzWUxzeXdnRWtMTTR4ZXRIYXhSOVVYVnpmcTBIajRHVElVb1duejBCOWpwYk44ODhnYUhnYnk3NmlTODdcbjYxWk1WdXlkY3dLQmdGb2FwUEdIa3E2dEg3dGpSWVVZTGJjS1M3QnNlbFB5dDE1UkdvaGRKMVNZb0c1MGhkOFhcbmk2VlN4b3R1MC9MaVFneHArQm5IakNDdkpKa3JPNnpwd0x6cUJYb2xVZ2duMFVvRGludlhQS2dnMzZibUFSa0tcbml6NmkrUW5kb1pqVE8vS0RpblRXSHJpQnZ2STRneFA4NjkwUEcxWVhnSHd5ZG5xelpNMFNNSmJ0QW9HQkFLMW5cbk5UT3BZMHExM092UnYxZTI0NTFkTXhlQjdoNXRFWDlSVzUrOEhZRURTQjZ3VG1xbUdBdTN4ZFhnQ1N1eFJUdlZcblBZRWxYOXQ0R2ltT0l0VFIzNCtKSGJscXU2UXB3N2dOWmdUcTBDWXNaTDdlTzg1YnhqRmltYzlvZjA1YTRsZUlcbmQwdXo4a2dSalVOQWozVDUxMWdUdUQ0bFhxQXd5U3FtRHNWNEdoN2hBb0dCQUtwUzlhVjBIL0QwNEFyNzAvTjFcbkVpb0UzdXQzVU9ObHVPSmUyNmRYdWYvSmszZmdVdzlpMUg0ajdqWnNuVzcrUXlDV3NnRE1PQzVmdnFrWkxjTVJcbjU3QU5rU2U2RTRlY21QRmZjM2JpcDhEb2ZhUTdtQTM3aUw0eU5jeFZObE5zUEVwOGVqc0VZQmlnOTUycE50V2VcbndPWkJrM002THNHVnNrS1ZLQkxFemVqNFxuLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLVxuIiwKICAiY2xpZW50X2VtYWlsIjogImNpLWNkLXBpcGVsaW5lQGNpcmN1bGFyLWZ1c2lvbi0zNDgxMTEuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLAogICJjbGllbnRfaWQiOiAiMTE0NDQ4NzgzNTY5NDQzMzEzOTUxIiwKICAiYXV0aF91cmkiOiAiaHR0cHM6Ly9hY2NvdW50cy5nb29nbGUuY29tL28vb2F1dGgyL2F1dGgiLAogICJ0b2tlbl91cmkiOiAiaHR0cHM6Ly9vYXV0aDIuZ29vZ2xlYXBpcy5jb20vdG9rZW4iLAogICJhdXRoX3Byb3ZpZGVyX3g1MDlfY2VydF91cmwiOiAiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vb2F1dGgyL3YxL2NlcnRzIiwKICAiY2xpZW50X3g1MDlfY2VydF91cmwiOiAiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vcm9ib3QvdjEvbWV0YWRhdGEveDUwOS9jaS1jZC1waXBlbGluZSU0MGNpcmN1bGFyLWZ1c2lvbi0zNDgxMTEuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iCn0K' | base64 --decode > gsa-key.json
        export GOOGLE_APPLICATION_CREDENTIALS=$(pwd)/gsa-key.json
        echo $GOOGLE_APPLICATION_CREDENTIALS
        cat $GOOGLE_APPLICATION_CREDENTIALS
    - name: Configure kubeconfig
      run: |
        echo "::set-output name=KUBECONFIG::$(echo -n 'YXBpVmVyc2lvbjogdjEKY2x1c3RlcnM6Ci0gY2x1c3RlcjoKICAgIGNlcnRpZmljYXRlLWF1dGhvcml0eS1kYXRhOiBMUzB0TFMxQ1JVZEpUaUJEUlZKVVNVWkpRMEZVUlMwdExTMHRDazFKU1VWTVZFTkRRWEJYWjBGM1NVSkJaMGxTUVU1bE5sRnBZekJyZDBaS2JsaFRjRlJ3ZUVWSGFHOTNSRkZaU2t0dldrbG9kbU5PUVZGRlRFSlJRWGNLVEhwRmRFMURjMGRCTVZWRlFYaE5hMXBxUW1sT2VscHNUMGRWZEZsWFRtaE5lVEF3VFhwU2JVeFVhM2hOTWxWMFdsUlJlVTVFVVRSYVZFa3lUa2RTYWdwTlEwRllSRlJKZVUxRVZYcE5SRUV5VFVSQmVrNVdiMWxFZWtsM1RsUkpkMDVVU1hsTlJHTjNUVVJOTVZkcVFYWk5VekIzUzNkWlJGWlJVVVJGZVZKdENrMUhTVE5PYlZVMFdsTXhhRmt5UlhwTVZGRjZUa2RaZEU5VVJYcGFVekZzVGtSSk1FNUVhR3hOYWxrd1drZE5kMmRuUjJsTlFUQkhRMU54UjFOSllqTUtSRkZGUWtGUlZVRkJORWxDYW5kQmQyZG5SMHRCYjBsQ1oxRkRiamxwV0hoR1VIaEVjWEJRTTNsRlZqRTRObXQzZDFGd2NsZHhhM1ZxTjNGT05YZFJaQXBXTkdacFNHeFFaelF2WTNWVVZFNWFLekJ6WTJSU2RHVTBSR1ZyWVVjNVlteFNjbmRXVnpBeVEzVjJZVTByVTBkcFNFODJUa296UjBSMFNHbElhMHMyQ2xGYVRFNUpjamRRZFVWRFdqbDNZbWxRU2pOeldFMURhVVkwYjJsVVRrOTVSbEl2V2pCbk1XcHVUV1pQUkd0d1VIaHJRVWxwUTNBelV6ZHFPRTVFYWtRS2QydHROVlptVUhGQ1REa3JORGQ1Y0hWdVRGZGtXRkIyWjBKMVoxWndTMmwwSzNkbVNrVk1Va2sxTVhOeGIwSlFSMUJTWWtGSWVXOHZUVWhFZUhWeFN3cGpWbTVKYUhkbFdYRnpXbkZETkdaemNVTk9ia05TTlhFNGJsTkJaSGhxYlRKYWJISnFPRXg0VVdKQ1ZWbEdaV1pKYTB0RlJtMTVjSFEyY1hoRlNrSXJDak12V0hOd2N6SXdObHBsZVd0Nk9FVmFWMGxPV0ZWbVJVcHJjRlE1Ykd4VWJpOTBlbHBHTnl0Q1N6SkJPWEphWTBFMGN6aFJOalZKVGxJMVlrZzNaMEVLZWxSaVEwNHllblZTU3pObVFsTXJjMUpOYm5JNE1FdEhPV2c0Y1ZGNlZubzBSbVZHTUdsR01VdHFRazVYTUhVdlpqY3diVlpCY0ZCblJrSk9kRzh3YVFwaVFrMURNbU5IZWxncmVTOUllSGxrU0hweGVGTnBZMnM0YlZSWVNTdGlSeXRsVERScU55dDBZMDUzVldWVlJVVm1TalYzTkVGSFoxbGFjRVJ2YVRjNENtMU5VWHBFYUVKR2JYVktOMHhtWmpacldFNWpNM0pSUzBobGEwTkJkMFZCUVdGT1EwMUZRWGRFWjFsRVZsSXdVRUZSU0M5Q1FWRkVRV2RKUlUxQk9FY0tRVEZWWkVWM1JVSXZkMUZHVFVGTlFrRm1PSGRJVVZsRVZsSXdUMEpDV1VWR1JuQmljQ3RKUW1wQ1QwdFRTRmhZVWt0aU1qWkxVa1JGVW5OTFRVRXdSd3BEVTNGSFUwbGlNMFJSUlVKRGQxVkJRVFJKUW1kUlFXRnlUbk5OY2xwRkszRTFWamd5U1ZCdU5tVTFjVEJaYTBsc2JUSjVibWd2WmxSeU56RTJXa2hWQ2pjck4ydDFZMVU1UTNJNGVqRnhUV1kzVVVWdVdDOW1ialpMV1VWc2VuSnFPRloxYWtod2FsVmhXak5aZVRsUlJYSlZUVVkyVGt4SlJtUk9TakJNUWs4S1VGWXJlSFU0VlV0TE5rd3diVloxWTJ0V1drbHNhWGhpUlVsblEwUldSWHB4WTJOWlUyRXljRTlaYkhwdlV6VnNTMEY2TVU1RFduSlJiVW94ZFdkMmNRcE1LMWw2UmxwcE5HdEtlRkZPVUVSTVZVeGFSemwwVEVnd2J6VklSRTVDU0hkcGVVcHJNMHBaTURsbmRFMVFkalZZVkhvMk1VbDVWM014UVVWSVVtSjVDblpIWVVzek1VTlVWWGx3VDJ0NmRXNVVOa0paZGtKbVFWSlNXVkpzVjFoaFFrRmFOamhYZFVSMVNUSndiR2x0VVhaa2IyeEZVRm94UXpsS2JEVnFjREVLV1hObE1tdG5ZVFphYkZOUVJHNWpVRVV6YVc5SFZFMWtZVlV6TjBkMlNFUlFhRVJPZWs1TUswbGtZVXBUTkcweWMxZG1ORU5QYkZwbFdrTm5WbFZoU0FvdllXZGFObmx0Wm05TFpqTmtRMmg2UVdRNGIyOTNLMDVzUzJGV1kwODRkMFIzZVdkSFIzSXJjRVZTWTNGb1ZVeFZXa1ZrVTJGcFpVcEllRUk1WlRCWUNrSjFaa2xtVEc5Q1ZGQnRMM1UyTlZaSU5sbFJTMDhyVVZKcGFtRjZjSGxLU25KbVpFMTZabnBFVGxsWVNsbHVjREZXVlc1U2RsUnRWVVowYURSNGVsZ0tXamxDVjBwTU5UWkVTWGt3SzBKdVVGVjZNVlptVGpBOUNpMHRMUzB0UlU1RUlFTkZVbFJKUmtsRFFWUkZMUzB0TFMwSwogICAgc2VydmVyOiBodHRwczovLzM1LjE5OC4yMzUuMTAxCiAgbmFtZTogZ2tlX2NpcmN1bGFyLWZ1c2lvbi0zNDgxMTFfYXNpYS1zb3V0aGVhc3QxLWJfbXktZmlyc3QtY2x1c3Rlci0xCmNvbnRleHRzOgotIGNvbnRleHQ6CiAgICBjbHVzdGVyOiBna2VfY2lyY3VsYXItZnVzaW9uLTM0ODExMV9hc2lhLXNvdXRoZWFzdDEtYl9teS1maXJzdC1jbHVzdGVyLTEKICAgIHVzZXI6IGNpLWNkLXBpcGVsaW5lLWdzYQogIG5hbWU6IGdrZV9jaXJjdWxhci1mdXNpb24tMzQ4MTExX2FzaWEtc291dGhlYXN0MS1iX215LWZpcnN0LWNsdXN0ZXItMQpjdXJyZW50LWNvbnRleHQ6IGdrZV9jaXJjdWxhci1mdXNpb24tMzQ4MTExX2FzaWEtc291dGhlYXN0MS1iX215LWZpcnN0LWNsdXN0ZXItMQpraW5kOiBDb25maWcKcHJlZmVyZW5jZXM6IHt9CnVzZXJzOgotIG5hbWU6IGNpLWNkLXBpcGVsaW5lLWdzYQogIHVzZXI6CiAgICBhdXRoLXByb3ZpZGVyOgogICAgICBjb25maWc6CiAgICAgICAgYWNjZXNzLXRva2VuOiB5YTI5LmMuYjBBWHYwelRORC1CRWQzZnc1bnNWUE5RNGt6MlBGR2E3d3dYTUpCX3VTMzUzVU01YWcwU0MzX1Q2LXRtdXAtWXlIMk9tVmlUcGZZM0FkdmQ5eGpnV1d4STJuSy1PWFJMeFgydndTeU1FdkVTQkhuMkhJMExWSE5zLXVBUUZ0VE9ZMEJESDZ4aFVKUW0tc1dtYWktdllDdUVnRzlScFhMdnpyazc5WV9nMW5zbVlCZmEzTTlFbVJWempxQjNSUzgwdnJyaXNWVmZMRkl4VUtsSE9DaUdKVVowalF6U2IzcmRMci4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uCiAgICAgICAgZXhwaXJ5OiAiMjAyMi0wNi0wM1QwNzoxOToyNC4wNTAxNjQrMDg6MDAiCiAgICAgIG5hbWU6IGdjcAo=' | base64 --decode)"
      id: kubeconfig
    - name: Set Kubernetes context
      uses: azure/k8s-set-context@v1
      with:
        method: kubeconfig
        kubeconfig: ${{ steps.kubeconfig.outputs.KUBECONFIG }}
      id: setcontext
    - name: Test kubeconfig
      run: |
        kubectl config view
        kubectl get ns